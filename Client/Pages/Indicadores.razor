@inject IJSRuntime JS
@inject HttpClient Http
<div class="col-6">
    <div>
    </div>
</div>
<div>

    <div class="app-content pt-3 p-md-3 p-lg-4">
        <div class="container-xl">

            <div class="app-card alert alert-dismissible shadow-sm mb-4 border-left-decoration" role="alert">
                <div class="inner">
                    <div class="app-card-body p-3 p-lg-4">
                        <h3 class="mb-3">Nueva Espezanza, Resumen!</h3>
                        <div class="row gx-5 gy-3">
                            <div class="col-12 col-lg-9">

                                <div>
                                    Consolidado de volumenes netos en campo.
                                </div>
                            </div><!--//col-->
                            <div class="col-12 col-lg-3">
                                <Tooltip Class="me-4" Title="Refrescar Datos">
                                    <button class="btn app-btn-primary" @onclick=Actualizar>
                                    <i class="bi bi-bootstrap-reboot"></i>
                                </button>
                                </Tooltip>
                                
                            </div><!--//col-->
                        </div><!--//row-->
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div><!--//app-card-body-->

                </div><!--//inner-->
            </div><!--//app-card-->

            <div class="row g-4 mb-4">
                <div class="col-6 col-lg-3">
                    <div class="app-card app-card-stat shadow-sm h-100">
                        <div class="app-card-body p-3 p-lg-4">
                            <h4 class="stats-type mb-1">STOCK HOY</h4>
                            <div class="stats-figure">@crudo</div>
                            <div class="stats-meta text-success">
                                <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-arrow-up"
                                     fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd"
                                          d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z" />
                                </svg> NSV
                            </div>
                        </div><!--//app-card-body-->
                        <a class="app-card-link-mask" href="#"></a>
                    </div><!--//app-card-->
                </div><!--//col-->

                <div class="col-6 col-lg-3">
                    <div class="app-card app-card-stat shadow-sm h-100">
                        <div class="app-card-body p-3 p-lg-4">
                            <h4 class="stats-type mb-1">STOCK HOY AGUA</h4>
                            <div class="stats-figure">@agua</div>
                            <div class="stats-meta text-success">
                                <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-arrow-down"
                                     fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd"
                                          d="M8 1a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L7.5 13.293V1.5A.5.5 0 0 1 8 1z" />
                                </svg> NSV AGUA
                            </div>
                        </div><!--//app-card-body-->
                        <a class="app-card-link-mask" href="#"></a>
                    </div><!--//app-card-->
                </div><!--//col-->
                <div class="col-6 col-lg-3">
                    <div class="app-card app-card-stat shadow-sm h-100">
                        <div class="app-card-body p-3 p-lg-4">
                            <h4 class="stats-type mb-1">DESPACHO</h4>
                            <div class="stats-figure">@despachos</div>
                            <div class="stats-meta">
                                NSV
                            </div>
                        </div><!--//app-card-body-->
                        <a class="app-card-link-mask" href="#"></a>
                    </div><!--//app-card-->
                </div><!--//col-->
                <div class="col-6 col-lg-3">
                    <div class="app-card app-card-stat shadow-sm h-100">
                        <div class="app-card-body p-3 p-lg-4">
                            <h4 class="stats-type mb-1">PRODUCCION</h4>
                            <div class="stats-figure">@produccion</div>
                            <div class="stats-meta">NSV</div>
                        </div><!--//app-card-body-->
                        <a class="app-card-link-mask" href="#"></a>
                    </div><!--//app-card-->
                </div><!--//col-->
            </div><!--//row-->
            <div class="row g-4 mb-4">
                <div class="col-6 col-lg-3">
                    <div class="app-card app-card-stat shadow-sm h-100">
                        <div class="app-card-body p-3 p-lg-4">
                            <h4 class="stats-type mb-1">STOCK AYER</h4>
                            <div class="stats-figure">@crudoAyer</div>
                            <div class="stats-meta text-success">
                                <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-arrow-up"
                                     fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd"
                                          d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z" />
                                </svg> NSV
                            </div>
                        </div><!--//app-card-body-->
                        <a class="app-card-link-mask" href="#"></a>
                    </div><!--//app-card-->
                </div><!--//col-->

                <div class="col-6 col-lg-3">
                    <div class="app-card app-card-stat shadow-sm h-100">
                        <div class="app-card-body p-3 p-lg-4">
                            <h4 class="stats-type mb-1">STOCK AYER AGUA</h4>
                            <div class="stats-figure">@aguaAyer</div>
                            <div class="stats-meta text-success">
                                <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-arrow-down"
                                     fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd"
                                          d="M8 1a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L7.5 13.293V1.5A.5.5 0 0 1 8 1z" />
                                </svg> NSV AGUA
                            </div>
                        </div><!--//app-card-body-->
                        <a class="app-card-link-mask" href="#"></a>
                    </div><!--//app-card-->
                </div><!--//col-->
                <div class="col-6 col-lg-3">
                    <div class="app-card app-card-stat shadow-sm h-100">
                        <div class="app-card-body p-3 p-lg-4">
                            <h4 class="stats-type mb-1">DESPACHO AYER</h4>
                            <div class="stats-figure">@despachosAyer</div>
                            <div class="stats-meta">
                                NSV
                            </div>
                        </div><!--//app-card-body-->
                        <a class="app-card-link-mask" href="#"></a>
                    </div><!--//app-card-->
                </div><!--//col-->
                <div class="col-6 col-lg-3">
                    <div class="app-card app-card-stat shadow-sm h-100">
                        <div class="app-card-body p-3 p-lg-4">
                            <h4 class="stats-type mb-1">PRODUCCION AYER</h4>
                            <div class="stats-figure">@produccionAyer</div>
                            <div class="stats-meta">NSV</div>
                        </div><!--//app-card-body-->
                        <a class="app-card-link-mask" href="#"></a>
                    </div><!--//app-card-->
                </div><!--//col-->
            </div><!--//row-->
            <div class="row g-4 mb-4">
                <div class="col-12 col-lg-6">
                    <div class="app-card app-card-progress-list h-100 shadow-sm">
                        <div class="app-card-header p-3">
                            <div class="row justify-content-between align-items-center">
                                <div class="col-auto">
                                    <h4 class="app-card-title">CAPACIDAD</h4>
                                </div><!--//col-->
                               
                            </div><!--//row-->
                        </div><!--//app-card-header-->
                        <div class="app-card-body">
                            <div class="item p-3">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <div class="title mb-1 ">Capacidad en tanques de crudo</div>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" role="progressbar"
                                                 style="width: @PorcentajeVolumenTanquesCrudo;" aria-valuenow="@PorcentajeVolumenTanquesCrudo" aria-valuemin="0"
                                                 aria-valuemax="100"></div>
                                        </div>
                                    </div><!--//col-->
                                    <div class="col-auto">
                                        <svg width="1em" height="1em" viewBox="0 0 16 16"
                                             class="bi bi-chevron-right" fill="currentColor"
                                             xmlns="http://www.w3.org/2000/svg">
                                            <path fill-rule="evenodd"
                                                  d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z" />
                                        </svg>
                                    </div><!--//col-->
                                </div><!--//row-->
                                <a class="item-link-mask" href="#"></a>
                            </div><!--//item-->


                            <div class="item p-3">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <div class="title mb-1 ">Ocupación en tanques de Nafta</div>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" role="progressbar"
                                                 style="width: @PorcentajeVolumenTanquesNafta;" aria-valuenow="@PorcentajeVolumenTanquesNafta" aria-valuemin="0"
                                                 aria-valuemax="100"></div>
                                        </div>
                                    </div><!--//col-->
                                    <div class="col-auto">
                                        <svg width="1em" height="1em" viewBox="0 0 16 16"
                                             class="bi bi-chevron-right" fill="currentColor"
                                             xmlns="http://www.w3.org/2000/svg">
                                            <path fill-rule="evenodd"
                                                  d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z" />
                                        </svg>
                                    </div><!--//col-->
                                </div><!--//row-->
                                <a class="item-link-mask" href="#"></a>
                            </div><!--//item-->  
                        </div><!--//app-card-body-->
                    </div><!--//app-card-->
                </div><!--//col-->
                <div class="col-12 col-lg-6">
                    <canvas id="myChart"></canvas>
                </div>
            </div><!--//row-->          

        </div><!--//container-fluid-->
    </div><!--//app-content-->



</div><!--//app-wrapper-->
<ControWell.Client.Pages.Analisis.DatosCampo />


@code {


    public static List<Tanque> Tanques = new List<Tanque>();
    public static List<Tanque> TanquesSinMov = new List<Tanque>();
    public static List<Balance> UltimosMovimientos = new List<Balance>();
    public static List<Balance> UltimosAyer = new List<Balance>();
    public static List<Balance> Balances = new List<Balance>();
    public static List<Balance> BalancesAyer = new List<Balance>();
    Consulta consulta = new Consulta();
    Consulta consultaAyer = new Consulta();
    Balance BalanceModal = new Balance();
    Tanque TanqueModal = new Tanque();
    double crudo = 0;
    double crudoAyer = 0;
    double agua = 0;
    double aguaAyer = 0;
    double nafta = 0;
    double naftaAyer = 0;
    double despachos = 0;
    double despachosAyer = 0;
    double produccion = 0;
    double produccionAyer = 0;
    double VolumenTanquesCrudo = 0;
    string PorcentajeVolumenTanquesCrudo = "0";
    double VolumenTanquesNafta = 0;
    string PorcentajeVolumenTanquesNafta = "0";
    double TovCrudo = 0;
    double TovNafta = 0;
    void FormatearVariables()
    {
        crudo = 0;
        crudoAyer = 0;
        agua = 0;
        aguaAyer = 0;
        nafta = 0;
        naftaAyer = 0;
        despachos = 0;
        despachosAyer = 0;
        produccion = 0;
        produccionAyer = 0;
        VolumenTanquesCrudo = 0;
        PorcentajeVolumenTanquesCrudo = "0";
        VolumenTanquesNafta = 0;
        PorcentajeVolumenTanquesNafta = "0";
        TovCrudo = 0;
        TovNafta = 0;
        Tanques.Clear();
        TanquesSinMov.Clear();
        UltimosMovimientos.Clear();
        UltimosAyer.Clear();
        Balances.Clear();
        BalancesAyer.Clear();
    }
    //Datos de la cosulta

    protected override async Task OnInitializedAsync()
    {
        await Actualizar();
        await JS.InvokeVoidAsync("Graficar", crudo, nafta, agua);
        JS.InvokeVoidAsync("Graficar", crudo, nafta, agua);
    }

    async Task Actualizar()
    {
        FormatearVariables();
        var resultadoTan = await Http.GetFromJsonAsync<List<Tanque>>("api/Tanque");
        if (resultadoTan != null)
            Tanques = resultadoTan;
        var resultadoTanSinMov = await Http.GetFromJsonAsync<List<Tanque>>("api/Tanque/SinMovimiento");
        if (resultadoTanSinMov != null)
            TanquesSinMov = resultadoTanSinMov;
        var ultimos = await Http.PostAsJsonAsync($"api/Balance/Aforos", consulta);
        UltimosMovimientos = await ultimos.Content.ReadFromJsonAsync<List<Balance>>();
        consultaAyer.FechaInicial = DateTime.Today.AddDays(-1);
        consultaAyer.FechaFinal = DateTime.Today;
        var ultimosAyer = await Http.PostAsJsonAsync($"api/Balance/Aforos", consultaAyer);
        UltimosAyer = await ultimosAyer.Content.ReadFromJsonAsync<List<Balance>>();
        var listadoBalances = await Http.PostAsJsonAsync("api/Balance/Rango", consulta);
        if (listadoBalances != null)
            Balances = await listadoBalances.Content.ReadFromJsonAsync<List<Balance>>();
        var listadoBalancesAyer = await Http.PostAsJsonAsync("api/Balance/Rango", consultaAyer);
        if (listadoBalancesAyer != null)
            BalancesAyer = await listadoBalancesAyer.Content.ReadFromJsonAsync<List<Balance>>();
        foreach (var i in UltimosMovimientos)
        {
            if (i.Tanque.TipoFluido == "Crudo")
            {
                crudo += i.NSV();
                agua += i.AGUANETA();
                TovCrudo += i.Tov;
            }
            if (i.Tanque.TipoFluido == "Refinado")
            {
                nafta += i.NSV();
                TovNafta += i.Tov;
            }
        }
        foreach (var i in UltimosAyer)
        {
            if (i.Tanque.TipoFluido == "Crudo")
            {
                crudoAyer += i.NSV();
                aguaAyer += i.AGUANETA();
            }
            if (i.Tanque.TipoFluido == "Refinado")
            {
                naftaAyer += i.NSV();
            }
        }
        foreach (var i in Balances)
        {
            if (i.Tanque.TipoFluido == "Crudo" && i.TipoMovimiento == "Despacho")
            {
                despachos += (double)i.DeltaNsv;
            }
            if (i.Tanque.TipoFluido == "Crudo" && i.TipoMovimiento == "Produccion")
            {
                produccion += (double)i.DeltaNsv;
            }
        }

        foreach (var i in BalancesAyer)
        {
            if (i.Tanque.TipoFluido == "Crudo" && i.TipoMovimiento == "Despacho")
            {
                despachosAyer += (double)i.DeltaNsv;
            }
            if (i.Tanque.TipoFluido == "Crudo" && i.TipoMovimiento == "Produccion")
            {
                produccionAyer += (double)i.DeltaNsv;
            }
        }
        aguaAyer = Math.Round(aguaAyer, 2);
        agua = Math.Round(agua, 2);

        foreach(var t in Tanques)
        {
            if (t.TipoFluido == "Crudo")
            {
                VolumenTanquesCrudo += (double)t.Capacidad;
            }
            if (t.TipoFluido == "Refinado")
            {
                VolumenTanquesNafta += (double)t.Capacidad;
            }
        }

        PorcentajeVolumenTanquesCrudo = Convert.ToString(Math.Round((TovCrudo / VolumenTanquesCrudo)*100, 0));
        PorcentajeVolumenTanquesNafta = Convert.ToString(Math.Round((TovNafta / VolumenTanquesNafta)*100, 0));
        Console.WriteLine(PorcentajeVolumenTanquesCrudo);
        Console.WriteLine(PorcentajeVolumenTanquesNafta);
    }
}
